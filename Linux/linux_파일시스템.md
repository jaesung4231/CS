# Linux 파일 시스템

저장장치에 파일 형태로 데이터를 저장하는 운영체제 내부의 코드로, 디스크의 파티션마다 다른 파일 시스템을 사용한다. 파일에 이름을 부여하고. 디스크의 파일위치를 기록해둔다.
응용프로그램이 운영체제에 파일을 요청하면 파일시스템을 통해 파일을 찾아 반환한다.

> 리눅스는 최대 4개의 파티션까지 사용할 수 있고, 보통 ext4 파일시스템을 사용하는데 Root 파일 시스템 단 1개에서 시작되어야 함. 다른 파일 시스템은 Root 파일시스템에 mount 시키는 방식으로 추가한다.

* **포맷**<br>
파티션을 해당 파일 시스템이 사용할 수 있도록 초기화하는 것

* **마운트**<br>
포맷된 파티션에 존재하는 파일에 접근, 생성, 삭제할 수 있도록 하는 작업. 


## 리눅스 파일 시스템의 구조

<img src='..\images\linux_file_structure.png' width=500 align=center>

* **Boot Block:**<br> 운영체제 코드가 저장되어 있다.

* **Super Block**<br>
    파일시스템 크기, 디스크의 물리적 정보, 파일 시스템 내 사용가능한 inode개수와 list, free데이터블록 개수와 리스트 등 전체 파일 시스템과 관련된 형상정보 유지
* **inode**<br> 모든 파일과 1:1로 대응되며, 파일의 이름(디렉토리명, 파일명)을 제외한 모든 정보(접근시간, 접근권한, 파일타입, 크기, 데이터 위치)인 메타데이터를 가지고있다. 파일의 생성 시 만들어지고 크기는 보통 256Bytes이고, 통상적으로 0번과 1번 아이노드는 사용되지 않는다.

* **Data Block**<br>
실제 파일의 데이터가 저장되는 공간. Inode번호를 찾기 위한 파일명이 존재한다.



## 리눅스 파일 시스템의 종류

### EXT

* **EXT**<br>
Linux의 가장 대표적인 파일 시스템이다.<br>
data modification timestamp와 inode 수정을 지원하지 않으며, linked list를 통해 free block과 inode를 추적하기 때문에 성능이 저하된다는 문제점이 존재하기 때문에, EXT2가 등장한다. 


* **EXT2**<br>
디스크에서 파일 시스템은 파티션 당 하나씩 생성된다. 파티션에 EXT2를 구축하면 파티션은 다수의 블록 그룹으로 나뉜다. 파일시스템을 블록 그룹으로 분할하면 같은 파일에 대한 inode와 data block이 인접한 실린더에 위치하게 되어 디스크 탐색시간을 줄일 수 있다는 장점이 있다.

    > **파티션(partition)**<br> 물리적인 디스크를 논리적인 저장영역으로 구별한 것 

    * **EXT2의 단점**<br>
        디스크에 data를 쓰는 동안 시스템 충돌이 발생하거나 전원이 끊어지면 심각한 손상을 입는다. 이때 재부팅이 이루어지는데, 검사프로그램을 전체 파일 시스템을 대상으로 실행해야 하며, 검사중에는 파일시스템을 사용할 수 없다.<br>
        이러한 단점을 보완하기 위해 EXT3 등장.


* **EXT3**<br>
    * **HTree 기술 도입**<br>
        EXT3에는 directory 검색 성능을 높이기 위해 hash 가번 HTree기술이 도입되었다.<br>
        EXT2는 directory를 단순 연결 리스트로 관리한다. 하지만 EXT3는 HTree 구조를 도입하여 directory내에 많은 파일이 존재하더라도 상수 시간 안에 접근할 수 있도록 한다.
    
    * **저널링 기능 지원**<br>
        > **저널링**<br> 시스템 충돌이나 정전과 같은 이벤트로 인해 발생할 수 있는 파일시스템 손상을 신속하게 복구하는 기능이다.

        EXT3는 EXT2와 달리 전체 파일 시스템을 검사할 필요가 없다. EXT3은 데이터를 파일시스템의 실제 영역에 기록하기 전에 해당 정보를 log영역에 기록한다. 이처럼 log를 기록하면 시스템이 갑자기 종료되더라도 위치를 파악할 수 있고, 파일시스템 전체를 검사할 필요가 없다.

    * **EXT3의 단점**<br>
        EXT3는 파일시스템과 파일의 최대 크기가 작고 연속적인 데이터 블록에 대해 비효율적인 인덱싱 방식을 사용하는 등, 여러 단점이 존재한다.
        > ex) 파일에 대한 disk 공간을 할당할 때 해당 블록에 0을 write해야 한다. 

* **EXT4**<br>
    * **대용량 파일시스템과 파일 크기 지원**<br> 
    EXT4는 48bits 블록 주소 지정을 사용하기 때문에 EXT3보다 더 큰 파일 시스템과 파일 크기를 지원한다.

    * **Pre-allocation(사전 할당)**<br>
    파일 생성 시 미리 일정 개수의 블록을 보장하는 기법. EXT4에서는 fallocate() 시스템 콜을 이용하여 pre-allocation 기능을 제공한다.
    
    * **Delayed allocation(지연 할당)**<br>
    free block count만 갱신하고 실제 블록 할당은 뒤로 미루는 방식.<br>
    EXT4는 프로세스가 write() 했을 때 블록을 즉시 할당하지 않고 데이터가 실제 disk에 write 될 때까지 할당을 지연합니다. 이때, block allocator가 블록 할당을 최적화할 수 있기 때문에 성능이 향상되고 fragmentation을 개선할 수 있습니다.

    * **Extent**<br>
    대용량 파일의 메타데이터를 줄이고 성능을 향상시키기 위한 기법이다.<br>
    EXT2, EXT3의 경우에는 disk 상에 연속적으로 블록을 할당하더라도 모든 단일 블록에 대한 매핑을 유지해야 한다.<br><br>
    EXT4에서는 이러한 문제를 해결하기 위해 extent를 사용한다. 메타데이터의 양을 줄이고 데이터 블록을 인덱싱하는 시간을 줄일 수 있다.
    > ex) 100번 블록부터 연속적인 50개 블록을 할당한 경우(100, 50)과 같은 정보만을 유지

### XFS
Silicon Graphics에서 개발한 고성능의 64bit 저널링 파일 시스템

#### XFS의 특징

* 64bit 파일 시스템으로 대용량 파일시스템에 효율적이다.

* EXT4보다 큰 최대 16EiB파일시스템과 최대 8EiB파일을 지원할 수 있다.

* B+tree를 사용하여 우수한 I/O 확장성을 제공하고 모든 사용자 데이터 및 메타데이터를 인덱싱한다.

* 파일시스템이 마운트되어 활성화되어 있는 동안 확장이 가능하다.

* extent 기반 할당을 사용하며 지연할당 및 사전 할당과 같은 여러 할당 체계를 가지고 있다.

* 지연할당을 통해 파일이 연속적인 블록 그룹에 저장될 가능성을 높이기 때문에 단편화를 줄이고 성능을 향상시킨다.

* 사전할당을 통해 애플리케이션이 사전에 저장할 데이터의 양을 알고 있는 경우 조각화를 방지하는 데 사용될 수 있다.

### tmpfs(Temp File System)

메모리를 파일처럼 사용할 수 있게 하는 파일 시스템이다.
#### **용도**
* 캐시: tmpfs는 자주 사용되는 데이터를 캐시하는 데 사용할 수 있다.

* 로그: tmpfs는 로그 파일을 저장하는 데 사용할 수 있다.

* 임시 파일: tmpfs는 임시 파일을 저장하는 데 사용할 수 있다.
#### **특징**

* 일반 파일 시스템의 파일 읽고 쓰기 속도보다 월등히 빠르다.

* 메모리처럼 휘발성이라 서버 재부팅되면 tmpfs안에 있는 모든 파일이 지워진다.

* 할당된 용량 이상이 사용되면 오류가 발생한다.(tmpfs 용량을 늘려주면 된다)
